{% extends "base.html" %}
{% block title %}Чат{% endblock %}

{% block content %}
<div class="chat-container">
  <div class="chat-window" id="chat-window">
    <h2>Чат с {{ initial_peer_name }}</h2>
    <div id="messages"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="Введите сообщение…" autocomplete="off" required>
      <button type="submit">Отправить</button>
    </form>
  </div>
</div>

<script>
    const SELF_ID = "{{ current_user.id }}";
    const PEER_ID = "{{ initial_peer_id }}";
  
    const msgContainer = document.getElementById('messages');
    const msgForm      = document.getElementById('message-form');
    const msgInput     = document.getElementById('message-input');
    let ws;
  
    // Рендер одного сообщения
    function appendMessage(msg) {
      const cls = msg.sender_id === SELF_ID ? 'mine' : 'theirs';
      const div = document.createElement('div');
      div.classList.add('message', cls);
      div.innerHTML = `
        <span class="time">${new Date(msg.created_at).toLocaleTimeString()}</span>
        <p>${msg.content}</p>`;
      msgContainer.appendChild(div);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }
  
    async function initChat() {
      // 1) Загружаем историю по правильному пути
      const resp = await fetch(`/chat/history?peer_id=${PEER_ID}`);
      if (resp.ok) {
        const history = await resp.json();
        history.forEach(appendMessage);
      } else {
        console.error('Не удалось загрузить историю чата');
      }
  
      // 2) Открываем только один WebSocket
      const proto = (location.protocol === 'https:' ? 'wss://' : 'ws://');
      ws = new WebSocket(`${proto}${location.host}/ws/chat/${PEER_ID}`);
      ws.onmessage = e => appendMessage(JSON.parse(e.data));
      ws.onclose   = () => console.log('WebSocket закрыт');
      ws.onerror   = e => console.error('Ошибка WebSocket', e);
    }
  
    // инициализация сразу при загрузке страницы
    initChat();
  
    // Отправка сообщения
    msgForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;
      ws.send(JSON.stringify({
        receiver_id: PEER_ID,
        content: text
      }));
      msgInput.value = '';
    });
  </script>
  
{% endblock %}
